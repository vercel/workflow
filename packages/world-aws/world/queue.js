'use strict';
Object.defineProperty(exports, '__esModule', { value: true });
exports.createQueue = void 0;
const client_sqs_1 = require('@aws-sdk/client-sqs');
const queue_1 = require('@vercel/queue');
const world_1 = require('@workflow/world');
const world_local_1 = require('@workflow/world-local');
const ulid_1 = require('ulid');
function parseQueueName(queueName) {
  const [prefix, queueId] = queueName.split('_');
  return [prefix, queueId];
}
function createQueue(client, config) {
  const port = process.env.PORT ? Number(process.env.PORT) : undefined;
  const embeddedWorld = (0, world_local_1.createEmbeddedWorld)({
    dataDir: undefined,
    port,
  });
  const transport = new queue_1.JsonTransport();
  const generateMessageId = (0, ulid_1.monotonicFactory)();
  const Queues = {
    __wkf_workflow_: config.queues.workflow,
    __wkf_step_: config.queues.step,
  };
  const createQueueHandler = embeddedWorld.createQueueHandler;
  const getDeploymentId = async () => {
    return 'aws';
  };
  const queue = async (queue, message, opts) => {
    const [prefix, queueId] = parseQueueName(queue);
    const queueUrl = Queues[prefix];
    const body = transport.serialize(message);
    const messageId = world_1.MessageId.parse(`msg_${generateMessageId()}`);
    await client.send(
      new client_sqs_1.SendMessageCommand({
        QueueUrl: queueUrl,
        MessageBody: JSON.stringify({
          id: queueId,
          data: body,
          attempt: 1,
          messageId,
          idempotencyKey: opts?.idempotencyKey,
        }),
        MessageDeduplicationId: opts?.idempotencyKey ?? messageId,
        MessageGroupId: queueId, // For FIFO queues
      })
    );
    return { messageId };
  };
  let isStarted = false;
  let shouldStop = false;
  async function pollQueue(queueUrl, queuePrefix) {
    while (!shouldStop) {
      try {
        const response = await client.send(
          new client_sqs_1.ReceiveMessageCommand({
            QueueUrl: queueUrl,
            MaxNumberOfMessages: 1,
            WaitTimeSeconds: 20, // Long polling
            VisibilityTimeout: 300, // 5 minutes
          })
        );
        if (!response.Messages || response.Messages.length === 0) {
          continue;
        }
        for (const message of response.Messages) {
          if (!message.Body || !message.ReceiptHandle) continue;
          try {
            const body = JSON.parse(message.Body);
            const payload = world_1.QueuePayloadSchema.parse(
              transport.deserialize(body.data)
            );
            // Create a queue name to pass to the embedded world
            const queueName = `${queuePrefix}${body.id}`;
            // Use the embedded world's queue handler
            const handler = createQueueHandler(
              queuePrefix,
              async (msg, meta) => {
                // The embedded world will handle the actual workflow/step execution
              }
            );
            // Make an HTTP request to the embedded world
            const request = new Request(
              `http://localhost:${port || 3000}/.well-known/workflow/v1/${queuePrefix === '__wkf_workflow_' ? 'flow' : 'step'}`,
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  message: payload,
                  meta: {
                    attempt: body.attempt || 1,
                    queueName,
                    messageId: body.messageId,
                  },
                }),
              }
            );
            const response = await handler(request);
            if (response.status === 200) {
              // Delete message from queue on success
              await client.send(
                new client_sqs_1.DeleteMessageCommand({
                  QueueUrl: queueUrl,
                  ReceiptHandle: message.ReceiptHandle,
                })
              );
            } else {
              // Message will become visible again after visibility timeout
              console.error(`Queue handler returned status ${response.status}`);
            }
          } catch (error) {
            console.error('Error processing message:', error);
            // Message will become visible again after visibility timeout
          }
        }
      } catch (error) {
        console.error('Error polling queue:', error);
        // Wait a bit before retrying
        await new Promise((resolve) => setTimeout(resolve, 5000));
      }
    }
  }
  async function start() {
    if (isStarted) return;
    isStarted = true;
    shouldStop = false;
    // Start polling both queues
    Promise.all([
      pollQueue(Queues.__wkf_workflow_, '__wkf_workflow_'),
      pollQueue(Queues.__wkf_step_, '__wkf_step_'),
    ]).catch((error) => {
      console.error('Queue polling error:', error);
    });
  }
  return {
    getDeploymentId,
    queue,
    createQueueHandler,
    start,
  };
}
exports.createQueue = createQueue;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVldWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJxdWV1ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxvREFLNkI7QUFDN0IseUNBQThDO0FBQzlDLDJDQU15QjtBQUN6Qix1REFBNEQ7QUFDNUQsK0JBQXdDO0FBR3hDLFNBQVMsY0FBYyxDQUFDLFNBQXlCO0lBQy9DLE1BQU0sQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQTBCLENBQUM7SUFDeEUsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztBQUMzQixDQUFDO0FBRUQsU0FBZ0IsV0FBVyxDQUN6QixNQUFpQixFQUNqQixNQUFzQjtJQUV0QixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNyRSxNQUFNLGFBQWEsR0FBRyxJQUFBLGlDQUFtQixFQUFDLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBRXhFLE1BQU0sU0FBUyxHQUFHLElBQUkscUJBQWEsRUFBRSxDQUFDO0lBQ3RDLE1BQU0saUJBQWlCLEdBQUcsSUFBQSx1QkFBZ0IsR0FBRSxDQUFDO0lBRTdDLE1BQU0sTUFBTSxHQUFHO1FBQ2IsZUFBZSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUTtRQUN2QyxXQUFXLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJO0tBQ2UsQ0FBQztJQUVqRCxNQUFNLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQztJQUU1RCxNQUFNLGVBQWUsR0FBNkIsS0FBSyxJQUFJLEVBQUU7UUFDM0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDLENBQUM7SUFFRixNQUFNLEtBQUssR0FB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SCxDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssVUFBVSxLQUFLO1FBQ2xCLElBQUksU0FBUztZQUFFLE9BQU87UUFDdEIsU0FBUyxHQUFHLElBQUksQ0FBQztRQUNqQixVQUFVLEdBQUcsS0FBSyxDQUFDO1FBRW5CLDRCQUE0QjtRQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ1YsU0FBUyxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsaUJBQWlCLENBQUM7WUFDcEQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDO1NBQzdDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNqQixPQUFPLENBQUMsS0FBSyxDQUFDLHNCQUFzQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU87UUFDTCxlQUFlO1FBQ2YsS0FBSztRQUNMLGtCQUFrQjtRQUNsQixLQUFLO0tBQ04sQ0FBQztBQUNKLENBQUM7QUF0SkQsa0NBc0pDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGVsZXRlTWVzc2FnZUNvbW1hbmQsXG4gIFJlY2VpdmVNZXNzYWdlQ29tbWFuZCxcbiAgU2VuZE1lc3NhZ2VDb21tYW5kLFxuICB0eXBlIFNRU0NsaWVudCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNxcyc7XG5pbXBvcnQgeyBKc29uVHJhbnNwb3J0IH0gZnJvbSAnQHZlcmNlbC9xdWV1ZSc7XG5pbXBvcnQge1xuICBNZXNzYWdlSWQsXG4gIFF1ZXVlUGF5bG9hZFNjaGVtYSxcbiAgdHlwZSBRdWV1ZSxcbiAgdHlwZSBRdWV1ZVByZWZpeCxcbiAgdHlwZSBWYWxpZFF1ZXVlTmFtZSxcbn0gZnJvbSAnQHdvcmtmbG93L3dvcmxkJztcbmltcG9ydCB7IGNyZWF0ZUVtYmVkZGVkV29ybGQgfSBmcm9tICdAd29ya2Zsb3cvd29ybGQtbG9jYWwnO1xuaW1wb3J0IHsgbW9ub3RvbmljRmFjdG9yeSB9IGZyb20gJ3VsaWQnO1xuaW1wb3J0IHR5cGUgeyBBV1NXb3JsZENvbmZpZyB9IGZyb20gJy4vY29uZmlnLmpzJztcblxuZnVuY3Rpb24gcGFyc2VRdWV1ZU5hbWUocXVldWVOYW1lOiBWYWxpZFF1ZXVlTmFtZSk6IFtRdWV1ZVByZWZpeCwgc3RyaW5nXSB7XG4gIGNvbnN0IFtwcmVmaXgsIHF1ZXVlSWRdID0gcXVldWVOYW1lLnNwbGl0KCdfJykgYXMgW1F1ZXVlUHJlZml4LCBzdHJpbmddO1xuICByZXR1cm4gW3ByZWZpeCwgcXVldWVJZF07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVRdWV1ZShcbiAgY2xpZW50OiBTUVNDbGllbnQsXG4gIGNvbmZpZzogQVdTV29ybGRDb25maWdcbik6IFF1ZXVlICYgeyBzdGFydCgpOiBQcm9taXNlPHZvaWQ+IH0ge1xuICBjb25zdCBwb3J0ID0gcHJvY2Vzcy5lbnYuUE9SVCA/IE51bWJlcihwcm9jZXNzLmVudi5QT1JUKSA6IHVuZGVmaW5lZDtcbiAgY29uc3QgZW1iZWRkZWRXb3JsZCA9IGNyZWF0ZUVtYmVkZGVkV29ybGQoeyBkYXRhRGlyOiB1bmRlZmluZWQsIHBvcnQgfSk7XG5cbiAgY29uc3QgdHJhbnNwb3J0ID0gbmV3IEpzb25UcmFuc3BvcnQoKTtcbiAgY29uc3QgZ2VuZXJhdGVNZXNzYWdlSWQgPSBtb25vdG9uaWNGYWN0b3J5KCk7XG5cbiAgY29uc3QgUXVldWVzID0ge1xuICAgIF9fd2tmX3dvcmtmbG93XzogY29uZmlnLnF1ZXVlcy53b3JrZmxvdyxcbiAgICBfX3drZl9zdGVwXzogY29uZmlnLnF1ZXVlcy5zdGVwLFxuICB9IGFzIGNvbnN0IHNhdGlzZmllcyBSZWNvcmQ8UXVldWVQcmVmaXgsIHN0cmluZz47XG5cbiAgY29uc3QgY3JlYXRlUXVldWVIYW5kbGVyID0gZW1iZWRkZWRXb3JsZC5jcmVhdGVRdWV1ZUhhbmRsZXI7XG5cbiAgY29uc3QgZ2V0RGVwbG95bWVudElkOiBRdWV1ZVsnZ2V0RGVwbG95bWVudElkJ10gPSBhc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuICdhd3MnO1xuICB9O1xuXG4gIGNvbnN0IHF1ZXVlOiBRdWV1ZVsncXVldWUnXSA9IGFzeW5jIChxdWV1ZSwgbWVzc2FnZSwgb3B0cykgPT4ge1xuICAgIGNvbnN0IFtwcmVmaXgsIHF1ZXVlSWRdID0gcGFyc2VRdWV1ZU5hbWUocXVldWUpO1xuICAgIGNvbnN0IHF1ZXVlVXJsID0gUXVldWVzW3ByZWZpeF07XG4gICAgY29uc3QgYm9keSA9IHRyYW5zcG9ydC5zZXJpYWxpemUobWVzc2FnZSk7XG4gICAgY29uc3QgbWVzc2FnZUlkID0gTWVzc2FnZUlkLnBhcnNlKGBtc2dfJHtnZW5lcmF0ZU1lc3NhZ2VJZCgpfWApO1xuXG4gICAgYXdhaXQgY2xpZW50LnNlbmQoXG4gICAgICBuZXcgU2VuZE1lc3NhZ2VDb21tYW5kKHtcbiAgICAgICAgUXVldWVVcmw6IHF1ZXVlVXJsLFxuICAgICAgICBNZXNzYWdlQm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGlkOiBxdWV1ZUlkLFxuICAgICAgICAgIGRhdGE6IGJvZHksXG4gICAgICAgICAgYXR0ZW1wdDogMSxcbiAgICAgICAgICBtZXNzYWdlSWQsXG4gICAgICAgICAgaWRlbXBvdGVuY3lLZXk6IG9wdHM/LmlkZW1wb3RlbmN5S2V5LFxuICAgICAgICB9KSxcbiAgICAgICAgTWVzc2FnZURlZHVwbGljYXRpb25JZDogb3B0cz8uaWRlbXBvdGVuY3lLZXkgPz8gbWVzc2FnZUlkLFxuICAgICAgICBNZXNzYWdlR3JvdXBJZDogcXVldWVJZCwgLy8gRm9yIEZJRk8gcXVldWVzXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4geyBtZXNzYWdlSWQgfTtcbiAgfTtcblxuICBsZXQgaXNTdGFydGVkID0gZmFsc2U7XG4gIGxldCBzaG91bGRTdG9wID0gZmFsc2U7XG5cbiAgYXN5bmMgZnVuY3Rpb24gcG9sbFF1ZXVlKHF1ZXVlVXJsOiBzdHJpbmcsIHF1ZXVlUHJlZml4OiBRdWV1ZVByZWZpeCkge1xuICAgIHdoaWxlICghc2hvdWxkU3RvcCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgUmVjZWl2ZU1lc3NhZ2VDb21tYW5kKHtcbiAgICAgICAgICAgIFF1ZXVlVXJsOiBxdWV1ZVVybCxcbiAgICAgICAgICAgIE1heE51bWJlck9mTWVzc2FnZXM6IDEsXG4gICAgICAgICAgICBXYWl0VGltZVNlY29uZHM6IDIwLCAvLyBMb25nIHBvbGxpbmdcbiAgICAgICAgICAgIFZpc2liaWxpdHlUaW1lb3V0OiAzMDAsIC8vIDUgbWludXRlc1xuICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKCFyZXNwb25zZS5NZXNzYWdlcyB8fCByZXNwb25zZS5NZXNzYWdlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgbWVzc2FnZSBvZiByZXNwb25zZS5NZXNzYWdlcykge1xuICAgICAgICAgIGlmICghbWVzc2FnZS5Cb2R5IHx8ICFtZXNzYWdlLlJlY2VpcHRIYW5kbGUpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKG1lc3NhZ2UuQm9keSk7XG4gICAgICAgICAgICBjb25zdCBwYXlsb2FkID0gUXVldWVQYXlsb2FkU2NoZW1hLnBhcnNlKFxuICAgICAgICAgICAgICB0cmFuc3BvcnQuZGVzZXJpYWxpemUoYm9keS5kYXRhKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgLy8gQ3JlYXRlIGEgcXVldWUgbmFtZSB0byBwYXNzIHRvIHRoZSBlbWJlZGRlZCB3b3JsZFxuICAgICAgICAgICAgY29uc3QgcXVldWVOYW1lOiBWYWxpZFF1ZXVlTmFtZSA9IGAke3F1ZXVlUHJlZml4fSR7Ym9keS5pZH1gO1xuXG4gICAgICAgICAgICAvLyBVc2UgdGhlIGVtYmVkZGVkIHdvcmxkJ3MgcXVldWUgaGFuZGxlclxuICAgICAgICAgICAgY29uc3QgaGFuZGxlciA9IGNyZWF0ZVF1ZXVlSGFuZGxlcihcbiAgICAgICAgICAgICAgcXVldWVQcmVmaXgsXG4gICAgICAgICAgICAgIGFzeW5jIChtc2csIG1ldGEpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBUaGUgZW1iZWRkZWQgd29ybGQgd2lsbCBoYW5kbGUgdGhlIGFjdHVhbCB3b3JrZmxvdy9zdGVwIGV4ZWN1dGlvblxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvLyBNYWtlIGFuIEhUVFAgcmVxdWVzdCB0byB0aGUgZW1iZWRkZWQgd29ybGRcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgUmVxdWVzdChcbiAgICAgICAgICAgICAgYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0IHx8IDMwMDB9Ly53ZWxsLWtub3duL3dvcmtmbG93L3YxLyR7XG4gICAgICAgICAgICAgICAgcXVldWVQcmVmaXggPT09ICdfX3drZl93b3JrZmxvd18nID8gJ2Zsb3cnIDogJ3N0ZXAnXG4gICAgICAgICAgICAgIH1gLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sXG4gICAgICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgICAgbWVzc2FnZTogcGF5bG9hZCxcbiAgICAgICAgICAgICAgICAgIG1ldGE6IHtcbiAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdDogYm9keS5hdHRlbXB0IHx8IDEsXG4gICAgICAgICAgICAgICAgICAgIHF1ZXVlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUlkOiBib2R5Lm1lc3NhZ2VJZCxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgaGFuZGxlcihyZXF1ZXN0KTtcblxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgICAgICAgIC8vIERlbGV0ZSBtZXNzYWdlIGZyb20gcXVldWUgb24gc3VjY2Vzc1xuICAgICAgICAgICAgICBhd2FpdCBjbGllbnQuc2VuZChcbiAgICAgICAgICAgICAgICBuZXcgRGVsZXRlTWVzc2FnZUNvbW1hbmQoe1xuICAgICAgICAgICAgICAgICAgUXVldWVVcmw6IHF1ZXVlVXJsLFxuICAgICAgICAgICAgICAgICAgUmVjZWlwdEhhbmRsZTogbWVzc2FnZS5SZWNlaXB0SGFuZGxlLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAvLyBNZXNzYWdlIHdpbGwgYmVjb21lIHZpc2libGUgYWdhaW4gYWZ0ZXIgdmlzaWJpbGl0eSB0aW1lb3V0XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFF1ZXVlIGhhbmRsZXIgcmV0dXJuZWQgc3RhdHVzICR7cmVzcG9uc2Uuc3RhdHVzfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwcm9jZXNzaW5nIG1lc3NhZ2U6JywgZXJyb3IpO1xuICAgICAgICAgICAgLy8gTWVzc2FnZSB3aWxsIGJlY29tZSB2aXNpYmxlIGFnYWluIGFmdGVyIHZpc2liaWxpdHkgdGltZW91dFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgcG9sbGluZyBxdWV1ZTonLCBlcnJvcik7XG4gICAgICAgIC8vIFdhaXQgYSBiaXQgYmVmb3JlIHJldHJ5aW5nXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDUwMDApKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBzdGFydCgpIHtcbiAgICBpZiAoaXNTdGFydGVkKSByZXR1cm47XG4gICAgaXNTdGFydGVkID0gdHJ1ZTtcbiAgICBzaG91bGRTdG9wID0gZmFsc2U7XG5cbiAgICAvLyBTdGFydCBwb2xsaW5nIGJvdGggcXVldWVzXG4gICAgUHJvbWlzZS5hbGwoW1xuICAgICAgcG9sbFF1ZXVlKFF1ZXVlcy5fX3drZl93b3JrZmxvd18sICdfX3drZl93b3JrZmxvd18nKSxcbiAgICAgIHBvbGxRdWV1ZShRdWV1ZXMuX193a2Zfc3RlcF8sICdfX3drZl9zdGVwXycpLFxuICAgIF0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcignUXVldWUgcG9sbGluZyBlcnJvcjonLCBlcnJvcik7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGdldERlcGxveW1lbnRJZCxcbiAgICBxdWV1ZSxcbiAgICBjcmVhdGVRdWV1ZUhhbmRsZXIsXG4gICAgc3RhcnQsXG4gIH07XG59XG4iXX0=
