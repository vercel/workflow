#!/usr/bin/env node

/**
 * Auto-generates _workflows.ts registry file for workbenches
 *
 * Usage: node generate-workflows-registry.js [workflowsDir] [outputPath]
 *
 * Defaults:
 *   workflowsDir: ./workflows
 *   outputPath: ./_workflows.ts
 */

const fs = require('node:fs');
const path = require('node:path');

// Get arguments or use defaults
const workflowsDir = process.argv[2] || './workflows';
const outputPath = process.argv[3] || './_workflows.ts';

// Calculate relative path from output to workflows directory
const outputDir = path.dirname(outputPath);
const relativeWorkflowsPath = path
  .relative(outputDir, workflowsDir)
  .replace(/\\/g, '/');

// Files to skip
const SKIP_FILES = ['helpers.ts'];
const SKIP_PREFIX = '_';

function generateSafeIdentifier(filename) {
  // Convert filename to safe JS identifier
  // e.g., "1_simple.ts" -> "workflow_1_simple"
  return (
    'workflow_' + filename.replace(/\.ts$/, '').replace(/[^a-zA-Z0-9_]/g, '_')
  );
}

function generateRegistry() {
  // Check if workflows directory exists
  if (!fs.existsSync(workflowsDir)) {
    console.error(`Error: Workflows directory not found: ${workflowsDir}`);
    process.exit(1);
  }

  // Read all files from workflows directory
  const files = fs
    .readdirSync(workflowsDir)
    .filter((file) => {
      // Only .ts files
      if (!file.endsWith('.ts')) return false;
      // Skip helpers and files starting with _
      if (SKIP_FILES.includes(file)) return false;
      if (file.startsWith(SKIP_PREFIX)) return false;
      return true;
    })
    .sort(); // Sort for consistent output

  if (files.length === 0) {
    console.warn('Warning: No workflow files found to register');
  }

  // Generate imports
  const imports = files
    .map((file) => {
      const identifier = generateSafeIdentifier(file);
      // Use relative path from output directory to workflows directory
      // Don't add .js extension - let the bundler resolve it
      let importPath;
      if (relativeWorkflowsPath && relativeWorkflowsPath !== 'workflows') {
        importPath = `${relativeWorkflowsPath}/${file.replace(/\.ts$/, '')}`;
      } else {
        importPath = `./workflows/${file.replace(/\.ts$/, '')}`;
      }
      return `import * as ${identifier} from '${importPath}';`;
    })
    .join('\n');

  // Generate registry object entries
  const registryEntries = files
    .map((file) => {
      const identifier = generateSafeIdentifier(file);
      return `  'workflows/${file}': ${identifier},`;
    })
    .join('\n');

  // Generate full content
  const content = `// Auto-generated by workbench/scripts/generate-workflows-registry.js
// Do not edit this file manually - it will be regenerated on build

${imports}

export const allWorkflows = {
${registryEntries}
} as const;
`;

  // Write to output file
  fs.writeFileSync(outputPath, content, 'utf-8');

  console.log(`âœ“ Generated ${outputPath} with ${files.length} workflow(s)`);
  files.forEach((file) => console.log(`  - workflows/${file}`));
}

// Run the generator
try {
  generateRegistry();
} catch (error) {
  console.error('Error generating workflows registry:', error);
  process.exit(1);
}
